<html>
<head>
	<!-- Credit to Shanimal on StackExchange for template code -->
	<title>StudyMoney</title>

	<!-- Latest compiled and minified CSS -->
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css">
	<link rel="stylesheet" href="css/researchCardExample.css">

	<!-- Install jQuery and underscore -->
	<script src="http://code.jquery.com/jquery-2.0.3.min.js"></script>
	<script src="http://documentcloud.github.com/underscore/underscore-min.js"></script>
	<script src="https://www.parsecdn.com/js/parse-1.1.15.min.js"></script>
	<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/js/bootstrap.min.js"></script>
</head>
<body>

	<!-- Create your template -->
	<script type="foo/bar" id="studyCard">
		<% if (Parse.User.current()) {
			username = Parse.User.current().attributes.username;
		} %>
		<div class = "cardpadding">
			<div class = "container-fluid card">
				<a data-toggle="collapse" href="#collapse<%= objectId %>">
          <div class="row row-xs-height">
            <div class="col-xs-3 col-xs-height col-middle">
              <br>
              <% if (emailedStudy(objectId)) { %>
                <span style="font-size:3em" class="glyphicon glyphicon-envelope"></span>
              <% } else { %>
                <br>
              <% } %>
            </div>
          </div>
					<div class = "row row-xs-height">     
						<div class = "col-xs-3 col-xs-height col-middle">
							<div class = "text-center pricecard">
								$<%= pay %>
							</div>
						</div>
						<div class = "col-xs-9 col-xs-height">
							<div class = "infocard">
								<div class = "row">
									<div class = "col-xs-9 col-xs-height">
									</div>
									<div id = "delbutton" class = "col-xs-3 col-xs-height">
										<% if (username == poster) { %>
										<button class="btn btn-primary btn-block" onclick="deleteCard('<%= objectId %>')"><span class = "buttontext">Delete</span></button>
										<% } %>
									</div>
								</div>
								<div class = "row">
									<div class = "col-xs-12">
										<span class = "cardTitle"><%= title %></span>
									</div>
								</div>
								<div class = "row">
									<div class = "col-xs-12">
										<span class = "cardReq">Reqs: <%= requirements %></span>
									</div>
								</div>
								<br>
								<div class = "row">
									<div class = "col-xs-6">
										<span class = "cardBottom"><%= duration %></span>
									</div>
									<div class = "col-xs-6 text-right">
										<span class = "cardBottom"><%= location %></span>
									</div>
								</div>
								<br>
							</div>
						</div>
					</div>
				</a>
			</div>
			<div id="collapse<%= objectId %>" class="collapse" class = "cardinfo">
				<div class = "container-fluid cardinfo">
					<div class = "row row-xs-height">
						<div class = "col-offset-xs-2 col-xs-10 col-xs-height">
							<br>
							<span class = "cardDescription">Description</span>
							<br>
							<span class = "cardReq"><%= description %></span>
						</div>
					</div>
					<br>
					<div class = "row row-xs-height descriptionbuttonrow">
						<div class = "col-xs-12 col-xs-height text-center">
							<a target="_blank" onclick="studyEmailed('<%= objectId %>')" href="mailto:<%= contact %>?subject=<%= titleplus %>&body=I%20am%20interested%20in%20this%20study.%20What%20do%20I%20need%20to%20do%20next?"><button type="button" class="btn btn-primary btn-lg btn-block"><span class = "buttontext">E-Mail</span></button></a>
						</div>
					</div>
					<br>
				</div>
			</div>
		</div>
		<br>
	</script>
	
	
	<div class = "header shadow">
		<div class = "row row-xs-height">
			<div class = "col-xs-3 col-xs-height col-bottom">
				<a href = "form.html"><button class ="btn btn-primary btn-lg"><span class = "buttontext">Post</span></button></a>
			</div>
			<div class = "col-xs-6 col-xs-height col-bottom">
				<center><span style="font-size: 6em">StudyMoney</span></center>
			</div>
			<div class = "col-xs-3 col-xs-height col-bottom">
				<div class = "text-right" id = "username"></div>
			</div>
		</div>
	</div>
	<div class = "filters">
		<div class="btn-group">
			<div class = "row row-xs-height">
				<div class = "col-xs-4 col-xs-height">
					<button id="pay" class="btn btn-primary btn-lg btn-block" onclick="redrawCards('pay')"><span class = "filtertext">Pay</span></button>
				</div>
				<div class = "col-xs-4 col-xs-height">
					<button id="updatedAt" class="btn btn-primary btn-lg btn-block" onclick="redrawCards('updatedAt')"><span class = "filtertext">Recent</span></button>
				</div>
				<div class = "col-xs-4 col-xs-height">
					<button id="duration" class="btn btn-primary btn-lg btn-block" onclick="redrawCards('duration')"><span class = "filtertext">Duration</span></button>
				</div>
			</div>
		</div>
	</div>
	<!-- Create target -->
	<div class = "cards">
		<div id="target"></div>
	</div>

	<!-- Some code to fetch the data and apply template -->

	<script type="text/javascript">
    // Dev
		Parse.initialize("DHajCy3H3C742pNLXqTPJUtsGqZ14Nqdysx9F7BP", "Ya92oZaK0PGflE5o2uHIcGauuowRxpRaUrPvspvm");
    // Production
	//	Parse.initialize("2Adfr8LRfl5VwX8WgHQHRKZo6GpNcsiUvdBXoBya", "xGwCwmFcuKXxI9JwDuRcJs8uch6UMQAYPre18dzH");

		var currentUser = Parse.User.current();
		if (currentUser) {
		    $("#username").html("<button onclick=\"Parse.User.logOut();location.reload();\" class =\"btn btn-primary btn-lg\"><span class = \"buttontext\">Log Out</span></button>");
		} else {
		    $("#username").html("<a href = \"signUp.html\"><button class =\"btn btn-primary btn-lg\"><span class = \"buttontext\">Log In</span></button></a>");
		}

    function studyEmailed(studyID) {
      if (currentUser) {
        currentUser.addUnique("emailedStudies", studyID);
        currentUser.save(null, {
          success: function(User) {
          window.location.reload();
          }
        });
      }
    }

    function emailedStudy(studyID) {
      if (currentUser) {
        if (currentUser.attributes["emailedStudies"].indexOf(studyID) > -1) {
          return true;
        } else {
          return false;
        }
      }
    }

		var temp = $("#studyCard").html();
		var us_temp = _.template(temp);
		var createCard = function(a) {$("#target").append(us_temp(a))};
		var ResearchStudy = Parse.Object.extend("ResearchStudy");
		var query = new Parse.Query(ResearchStudy);
		query.descending("pay");
		$("#pay").addClass("active");
		query.find({
			success: function(results) {
				results.forEach(function(result){
					var cardinfo = result.attributes;
					cardinfo['objectId'] = result.id;
          			cardinfo['titleplus'] = "RE: " + result.attributes.title.replace(/\s/,"%20") + " Research Study";
					createCard(cardinfo)
				});
			},
			error: function(error) {
                // error is an instance of Parse.Error.
              }
            });

		function redrawCards(filter) {
        //var datePosted = document.getElementById("datePosted").checked;
        //var pay = document.getElementById("pay").checked;
        if (filter == "pay") {
        	$("#pay").addClass("active");
        	$("#updatedAt").removeClass("active");
        	$("#duration").removeClass("active");
        }
        else if(filter == "updatedAt"){
        	$("#pay").removeClass("active");
        	$("#updatedAt").addClass("active");
        	$("#duration").removeClass("active");
        }
        else {
        	$("#pay").removeClass("active");
        	$("#duration").addClass("active");
        	$("#updatedAt").removeClass("active");

        }

		var target = $("#target").html('');
        var q = new Parse.Query(ResearchStudy);
        

        if (filter == "duration"){
        	filter = "length";
        	q.ascending(filter);
        }
        else{
        	q.descending(filter);

        }

        
        
        q.find({
        	success: function(results) {
        		results.forEach(function(result){
        			if (!result.attributes.length && filter == "length") {
        				return false;
        			}
        			var cardinfo = result.attributes;
        			cardinfo['objectId'] = result.id;
              		cardinfo['titleplus'] = "RE: " + result.attributes.title.replace(/\s/,"%20") + " Research Study";
        			createCard(cardinfo)
        		});
        	},
        	error: function(error) {
            // error is an instance of Parse.Error.
          }
        });
      }
      //var template = $("#studyCard").html();
      //$("#target").html(_.template(template,{items:items}));

      function deleteCard(cardID){
      	var ResearchStudy = Parse.Object.extend("ResearchStudy");
      	var query = new Parse.Query(ResearchStudy);

      	query.get(cardID, {
      		success: function(object) {
      			if (_.isEqual(object.attributes.poster, Parse.User.current().attributes.username)){
					object.destroy({});
					alert("Card");
	      			window.location.reload();

      			} else {
      				alert("You do not have permission to delete this card!");
      			}

      		},
      		error: function(object, error) {alert("Parse failed with error code: " + error.code);}
      	})
      }
    </script>
  </body>
  </html>
